<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="../../src/lib/infusion/infusion-all.js"></script>
        <script src="../../src/lib/pouchdb/dist/pouchdb.js"></script>
        <script src="../../src/lib/gpii-pouchdb/src/js/pouchdb-common.js"></script>
        <script src="../../src/lib/jsonlint/web/jsonlint.js"></script>

        <script src="../../src/js/eventInTimeAware.js"></script>
        <script src="../../src/js/dataSource.js"></script>
        <script src="../../src/js/pouchPersisted.js"></script>
        <link rel="stylesheet" type="text/css" href="../../src/lib/infusion/src/components/inlineEdit/css/InlineEdit.css" />
        <link rel="stylesheet" type="text/css" href="../../src/lib/infusion/src/framework/core/css/fluid.css" />
    </head>

    <body>
        <h1>pouchPersisted Grade Example</h1>
        <p>
            A simple example of an inlineEdit component that persists its <code>model.value</code> to PouchDB.
        </p>
        <p>
            Instructions:
            <ul>
                <li>
                    Edit the text.
                </li>
                <li>
                    Reload the page; you'll see your text has persisted.
                </li>
                <li>
                    The log will also update.
                </li>
            </ul>
        </p>
        <h2>Edit Here</h2>
        <div class="floec-persistedInlineEdit">
            <div class="flc-inlineEdit-text">

            </div>
            <div>
                <a href="#" class="floec-persistedInlineEdit-delete">Delete Persisted Model</a>
            </div>
            <h3>Persistence Log</h3>
            <ul class="floec-persistedInlineEdit-loggingArea">

            </ul>
        </div>
    <script>
        fluid.defaults("floe.dashboard.pouchPersistedInlineEdit", {
            gradeNames: ["floe.dashboard.pouchPersisted", "fluid.inlineEdit"],
            invokers: {
                // Override the standard timestamp-based approach to a
                // fixed ID, for sake of this example; this allows us to
                // retrieve the relevant persisted grade without needing
                // functionality for search or filtering
                "setPouchId": {
                    funcName: "floe.dashboard.pouchPersisted.setPouchIdToString",
                    args: ["{that}", "myFixedId"]
                }
            },
            selectors: {
                storageLog: ".floec-persistedInlineEdit-loggingArea",
                deleteControl: ".floec-persistedInlineEdit-delete"
            },
            dbOptions: {
                "name": "examples"
            },
            listeners: {
                // Try and retrieve the component on creation
                "onCreate.get": {
                    funcName: "{that}.get",
                    priority: "after:setPouchId",
                    args: [{"revs_info": true}]
                },
                "onCreate.bindDeleteClick": {
                    priority: "after:setPouchId",
                    funcName: "floe.dashboard.pouchPersistedInlineEdit.bindDeleteClick",
                    args: ["{that}"]
                },
                // Update the log from retrieval
                "onPouchDocRetrieved.updateLogFromRetrieved": {
                    funcName: "floe.dashboard.pouchPersistedInlineEdit.updateLogFromRetrieved",
                    args: ["{that}", "{arguments}.0"]
                },
                // Set the model from retrieval
                "onPouchDocRetrieved.setModelFromRetrieved": {
                    funcName: "floe.dashboard.pouchPersistedInlineEdit.setModelFromRetrieved",
                    args: ["{that}", "{arguments}.0"]
                },
                "onPouchDocStored.updateLogFromStored": {
                    funcName: "floe.dashboard.pouchPersistedInlineEdit.updateLogFromStored",
                    args: ["{that}", "{arguments}.0"]
                },
                "onPouchDocDeleted.updateLogFromDeleted": {
                    funcName: "floe.dashboard.pouchPersistedInlineEdit.updateLogFromDeleted",
                    args: ["{that}", "{arguments}.0"]
                },
                // Persists the component when changes are made
                "modelChanged.persist": {
                    funcName: "{that}.persist"
                }
            }
        });

        floe.dashboard.pouchPersistedInlineEdit.bindDeleteClick = function (that) {
            console.log(that);
                var deleteControl = that.locate("deleteControl");
                deleteControl.click( function (e) {
                    e.preventDefault();
                    that.delete();
                });
        };

        floe.dashboard.pouchPersistedInlineEdit.setModelFromRetrieved = function(that, retrieved) {
            if(retrieved) {
                that.applier.change("", retrieved);
                that.refreshView();
            }
        };

        floe.dashboard.pouchPersistedInlineEdit.updateLogFromRetrieved = function (that, retrieved) {
            var logArea = that.locate("storageLog");
            logArea.prepend("<li>Persisted component retrieved:<br /><pre><code>" + JSON.stringify(retrieved, null, 2)+"</code></pre></li>");
        };

        floe.dashboard.pouchPersistedInlineEdit.updateLogFromStored = function (that, storeResponse) {
            var logArea = that.locate("storageLog");
            logArea.prepend("<li>Persisted component stored:<br /><pre><code>" + JSON.stringify(storeResponse, null, 2)+"</code></pre></li>");
        };

        floe.dashboard.pouchPersistedInlineEdit.updateLogFromDeleted = function (that, deleteResponse) {
            var logArea = that.locate("storageLog");
            logArea.prepend("<li>Persisted component deleted:<br /><pre><code>" + JSON.stringify(deleteResponse, null, 2)+"</code></pre></li>");
        };

        floe.dashboard.pouchPersistedInlineEdit(".floec-persistedInlineEdit");
    </script>

    </body>
</html>
